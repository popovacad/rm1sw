# RM1SW
## Считыватель для систем контроля и управления доступом

RM1SW применяются в качестве основных считывателей карт доступа в СКУД Академии.

В отличие от большинства считывателей, представленных на рынке (даже на сегодняшний день), RM1SW позволяет производить чтение идентификатора доступа из защищенного хранилища карт Mifare Classic, что повышает уровень защищенности СКУД и существенно осложняет подделку карт и прочие атаки.

Особенно актуально вопрос доступности считывателей с такими возможностями (и за адекватную стоимость) стоял на момент разработки устройства — 2014 год. Более того, существующие на тот момент актуальные и доступные методы атак на карты Classic сводили на нет защищенность систем, построенных с использованием любых доступных на рынке коммерческих считывателей. В то же время автором были разработаны эффективные методы противодействия большинству существующих широкодоступных атак на Classic. По этим причинам было принято решение разработать собственный считыватель для целей интеграции в СКУД Академии.

Устройство и микропрограмма разработаны отделом информационных и мультимедийных технологий Академии хорового искусства имени В.С. Попова (авторы: Александр Симонов, 2014−2021).

### Основные возможности устройства

- Чтение данных из защищенной ключами Crypto1 области карт Mifare Classic.
- Возможность гибко задавать параметры расположения идентификатора в памяти карты, что позволяет создавать и использовать комбинированные пропуска. Например, можно совместить карту «Тройка» с пропуском в учреждение, при этом не используя только лишь ее UID, который достаточно легко подделать.
- Дополнительно к чтению идентификатора возможно чтение проверочной последовательности для определения принадлежности карты к определенной системе и отклонения не прошедших проверку карт. Последовательность также читается из защищенной области и возможно гибкое задание параметров ее расположения.
- Вывод считанных данных в стандартном формате Wiegand, который совместим с подавляющим большинством контроллеров СКУД. Кроме использования стандартного Wiegand-26, возможно выдавать любое необходимое количество бит и установить наличие или отсутствие контрольной суммы в посылке (количество бит в таком случае будет зависеть от длины считываемого идентификатора и необходимости наличия контрольной суммы — т.н. «автоматический режим Wiegand»). Также настраивается длительность импульса и паузы при передаче бит.
- Богатая звуковая и световая индикация: 4 ярких трехцветных светодиода и звуковысотный бипер. Возможность управления индикацией непосредственно с контроллера СКУД.
- Простой дизайн устройства: небольшое количество доступных компонентов, простая ремонтопригодная печатная плата, очень стабильный и надежный МК серии STM8.
- Проверено временем: за всё время работы массы таких считывателей как в Академии, так и за ее пределами, ни один считыватель ни разу не вышел из строя и даже не завис. Это более 7 лет (!) работы для первых устройств, в том числе в суровых уличных условиях.
- Возможность установки в стандартный корпус типа BOX-KA11 на штатные места для крепления.
- Неограниченные возможности по модификации: можно добавить поддержку различных типов карт (например Mifare Plus или Ultralight C), шифрование данных идентификаторов и проверку их ЭП с привязкой к UID карты, нужным образом модифицировать функционал или поведение устройства, и т.д. Возможно даже добавить функционал выпуска и записи карт доступа и связи считывателя с ПК — радиомодуль RDM880 способен записывать данные на карты, а само устройство схемотехнически полностью готово к соединению с ПК через контакты Wiegand с использованием переходника UART-USB и одного дополнительного внешнего резистора (при этом будет задействована аппаратная периферия UART на STM8).

### Конфигурирование считывателя и выпуск карт доступа

Для первичной настройки ридера необходимо занести в его память конфигурацию, содержащую все необходимые данные и режимы работы.

Для перевода считывателя в режим конфигурирования нужно замкнуть контакт CFG основного разъема на землю и подать на устройство питание. Считыватель в режиме конфигурирования непрерывно мигает синим светодиодом и питается прочитать конфигурацию из специально подготовленной карты Classic.

Данные конфигурации должны быть записаны в карту в виде последовательности байт в первый сектор (блоки с 4 по 6 включительно), при этом первый сектор карты должен находиться в транспортной конфигурации.

Описание формата данных конфигурации (значения байт в шестнадцатеричном представлении):

1. Проверочная последовательность, 4 байта:

   46 55 43 4B

2. Версия данных конфигурации, 1 байт:

   01

3. Тип ключа для чтения данных проверочной последовательности на карте, 1 байт:

   00 — чтение с ключом A;

   01 — чтение с ключом B.

4. Значение ключа для чтения данных проверочной последовательности на карте, 6 байт:

   XX XX XX XX XX XX

5. Начальный блок на карте, где располагаются данные проверочной последовательности, 1 байт:

   01 — чтение из блока 1 (блок 1 сектора 0);

   04 — чтение из блока 4 (блок 0 сектора 1);

   0A — чтение из блока 10 (блок 3 сектора 2);

   и т.д.

6. Количество блоков для чтения с карты, где располагаются данные проверочной последовательности, 1 байт, от 1 до 4:

   02 — читать 2 блока;

   04 — читать 4 блока;

   Необходимо учитывать указанный ранее начальный блок, чтобы не выйти за границы сектора.

7. Начальный отступ данных (в байтах) проверочной последовательности в прочитанном из карты массиве блоков, 1 байт:

   05 — отступ 5 байт (читать, начиная с 6 байта);

   00 — нет отступа;

   и т.д. Может быть полезно, когда проверочные данные располагаются не точно в начале блока карты или на границе соседних блоков.

8. Длина данных (в байтах) проверочной последовательности, 1 байт, от 0 до 4:

   00 — отключить чтение и сравнение проверочной последовательности;

   02 — сравнивать последовательность длиной 2 байта;

   04 — сравнивать последовательность длиной 4 байта;

   и т.д.

9. Образец проверочных данных для сравнения, 4 байта:

   XX XX XX XX

   при этом следует ориентироваться на вышеуказанную длину проверочных данных. Даже если длина меньше 4 (допустим, 3), то всё равно следует заполнять все 4 байта, но сверяться будут только лишь первые 3. Значение незначащих байт не важно, можно их установить, например, в 00.

10. Тип ключа для чтения данных идентификатора доступа на карте, 1 байт:

    00 — чтение с ключом A;

    01 — чтение с ключом B.

11. Значение ключа для чтения данных идентификатора доступа на карте, 6 байт:

    XX XX XX XX XX XX

12. Начальный блок на карте, где располагаются данные идентификатора доступа, 1 байт:

    01 — чтение из блока 1 (блок 1 сектора 0);

    04 — чтение из блока 4 (блок 0 сектора 1);

    0A — чтение из блока 10 (блок 3 сектора 2);

    и т.д.

13. Количество блоков для чтения с карты, где располагаются данные идентификатора доступа, 1 байт, от 1 до 4:

    02 — читать 2 блока;

    04 — читать 4 блока;

    Необходимо учитывать указанный ранее начальный блок, чтобы не выйти за границы сектора.

14. Начальный отступ данных (в байтах) идентификатора доступа в прочитанном из карты массиве блоков, 1 байт:

    05 — отступ 5 байт (читать, начиная с 6 байта);

    00 — нет отступа;

    и т.д. Может быть полезно, когда идентификатора доступа располагается не точно в начале блока карты или на границе соседних блоков.

15. Длина данных (в байтах) идентификатора доступа, 1 байт, от 3 до 8 и 0:

    00 — отключить чтение идентификатора доступа и вместо этого выводить в контроллер СКУД данные 4-байтового UID карты;

    03 — идентификатор доступа длиной 2 байта;

    04 — идентификатор доступа длиной 4 байта;

    и т.д.

16. Длительность импульса Wiegand, 1 байт, указывается в квантах 100 мкс на единицу:

    01 — импульс 100 мкс;

    05 — импульс 500 мкс;

    и т.д.

17. Длительность паузы между импульсами Wiegand, 1 байт, указывается в квантах 100 мкс на единицу:

    01 — пауза 100 мкс;

    05 — пауза 500 мкс;

    и т.д.

18. Тип вывода Wiegand, 1 байт:

    Поддерживается два типа вывода:

    - тип 00: автоматическое количество бит, в зависимости от длины идентификатора доступа (длина 3 байта — Wiegand-24/26, длина 4 байта — Wiegand-32/34 и т.д.);

    - тип 01: фиксированный Wiegand-24/26, вне зависимости от длины идентификатора доступа: если длина больше 3 байт, то посылка Wiegand формируется только лишь на основе данных первых 3 байт.

    Установка старшего бита означает добавление в посылку Wiegand битов четности, т.о.:

    00 — авто без четности (Wiegand-24, Wiegand-32 и т.д.);

    80 — авто с четностью (Wiegand-26, Wiegand-34 и т.д.);

    01 — фикс Wiegand-24;

    81 — фикс Wiegand-26.

    Порядок вывода бит — прямой, непрерывный, «слева направо». Т.е. первый значащий бит в Wiegand-посылке будет старшим («самым левым») битом первого по расположению в считанном массиве («самого левого») байта данных.

19. Контрольная сумма данных конфигурации, 1 байт.

    Вычисляется как последовательное сложение по модулю 2 (XOR) значений всех предыдущих байтов.

Последовательность байт в вышеуказанном формате проще всего предварительно подготовить вручную в виде файла-образа данных конфигурации в любом удобном HEX-редакторе, в котором сразу можно будет также посчитать и их контрольную сумму (п. 19). После чего записать подготовленные данные на карту, используя программное обеспечение ридера, с помощью которого Вы впоследствии будете выпускать карты доступа.

При успешном чтении конфигурации с карты, считыватель подаст 1 сигнал зеленым светодиодом, в случае неудачи — красным. При этом, 2 сигнала красным означают ошибку в данных конфигурации, а 1 или 3 сигнала красным — ошибку чтения карты. После удачного считывания и проверки данных конфигурации происходит автоматическая запись конфигурации в энергонезависимую память считывателя — считыватель можно отключать, размыкать контакт CFG и включать в обычном режиме.

Для записи (выпуска) карт доступа можно использовать любой из недорогих доступных на рынке ридеров общего назначения для ПК, поддерживающих Mifare Classic, для которого имеется штатное программное обеспечение (продуктивное или тестовое), реализующее функции работы с картами.

### Описание представленных материалов

В репозитории представлено всё необходимое для сборки, программирования и запуска устройства:

- Схемотехника и разводка печатной платы, выполненная в пакете DipTrace.
- Дополнительно приложены PDF-рендеры схемотехники и платы для удобства ознакомления с дизайном устройства.
- Список элементов для сборки устройства.
- Пакет файлов в формате Gerber X2 для заказа печатной платы на производстве.
- Исходные коды микропрограммы, выполненные в среде IAR для STM8 (возможно портировать исходники в любую другую бесплатную среду или использовать для сборки открытый SDCC: https://github.com/hbendalibraham/stm8_started).
- Служебную утилиту для генерации файла с определением нот в зависимости от настроек аппаратного таймера STM8.
- Информацию по модулю RDM880 и его протоколу обмена с описанием команд.

**Обращаем внимание, что из состава микропрограммы исключен дополнительный функционал определения подделок и защиты от клон-карт Mifare Classic, так как он представляет собой авторское ноу-хау. В остальном микропрограмма представлена в полном объеме и в рабочем функциональном виде.**

Дизайн устройства и его базовая микропрограмма свободно распространяется в виде исходных кодов под лицензией GPLv3. Устройство может быть изготовлено и использовано всеми желающими на бесплатной основе (с условием соблюдения положений лицензионного соглашения).

По вопросам внедрения, использования устройства, его поддержки и доработки на платной основе, Вы можете обращаться в отдел информационных и мультимедийных технологий Академии хорового искусства имени В.С. Попова любым удобным способом, указанном в разделе «Контакты» официального сайта Академии: http://axu.ru/contacts
